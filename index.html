<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALORANT Tracker Overlay</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Google AdSense script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6090439809602995"
     crossorigin="anonymous"></script>
</head>
<body>
    <div class="background"></div>
    
    <!-- 製作者紹介セクション -->
    <div class="author-section">
        <p class="author-text">Project by にど寝</p>
        <img src="assets/images/nidone.png" alt="製作者アバター" class="author-avatar">
    </div>

    <!-- Google AdSense広告ユニット -->
    <div class="ad-container">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6090439809602995"
             data-ad-slot="1000000000000000"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div id="inputSection" class="input-section">
        <h2>VALORANT プレイヤー情報</h2>
        <div class="input-form">
            <input type="text" id="playerName" placeholder="プレイヤー名" required>
            <input type="text" id="playerTag" placeholder="タグ" required>
            <button onclick="generateURL()">URLを生成</button>
        </div>
        <div class="url-output">
            <input type="text" id="generatedURL" readonly>
            <button onclick="copyURL()">コピー</button>
        </div>
    </div>

    <div class="overlay">
        <div class="rank-section">
            <img src="assets/images/ranks/ランクなし.png" alt="Rank Icon" class="rank-icon" id="rankIcon">
            <div class="rank-details">
                <div class="rank-name-line">
                    <span class="rank-name" id="rankText">ランクなし</span> <span class="rr" id="rrText">0RR</span>
                </div>
                <span class="win-loss" id="winLossText">0 Win / 0 Loss</span>
            </div>
        </div>
        <div class="last-match-section" id="lastMatchSection">
            <div class="mmr-gauge-fill"></div>
            <span class="last-match-text" id="lastMatchText">Last Match +0pts</span>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script>
        async function updatePlayerInfo(name, tag) {
            try {
                const stats = await fetchPlayerStats(name, tag);

                console.log('Stats:', stats);

                if (stats && stats.data) {
                    const playerData = stats.data; // stats.data の内容を直接使用

                    // ランク情報を更新
                    const currentRank = playerData.currenttierpatched;
                    const rankingInTier = playerData.ranking_in_tier;
                    const mmrChange = playerData.mmr_change_to_last_game; // MMR変動値を取得

                    if (currentRank) {
                        // APIから取得した画像のURLを使用
                        if (playerData.images && playerData.images.large) {
                             document.getElementById('rankIcon').src = playerData.images.large;
                        } else {
                             // APIに画像URLがない場合はローカル画像を使用（フォールバック）
                             document.getElementById('rankIcon').src = getRankImageUrl(currentRank);
                        }

                        document.getElementById('rankText').textContent = currentRank;
                        document.getElementById('rrText').textContent = `${rankingInTier || 0}RR`;

                        // 勝敗情報はMMRデータに含まれていないため表示しない（必要であればプロフィールAPIから取得）
                        document.getElementById('winLossText').textContent = '';

                        // 直近のマッチ結果（MMR変動値）を更新
                        const lastMatchSection = document.getElementById('lastMatchSection');
                        const lastMatchText = document.getElementById('lastMatchText');
                        const mmrGaugeFill = lastMatchSection.querySelector('.mmr-gauge-fill');

                        if (mmrChange !== undefined) {
                            const sign = mmrChange >= 0 ? '+' : '';
                            lastMatchText.textContent = `Last Match ${sign}${mmrChange}pts`;

                            // ゲージの幅を計算 (例: ±100を最大/最小としてパーセンテージ化)
                            let gaugePercentage = Math.min(100, Math.abs(mmrChange)); // 最大100%
                            
                            if (mmrChange > 0) {
                                mmrGaugeFill.style.width = `${gaugePercentage}%`;
                                mmrGaugeFill.style.backgroundColor = '#4CAF50'; // 緑
                            } else if (mmrChange < 0) {
                                // マイナスの場合は右側からゲージを減らす（CSSで調整可能だがJSでシンプルに幅制御）
                                mmrGaugeFill.style.width = `${gaugePercentage}%`;
                                mmrGaugeFill.style.backgroundColor = '#F44336'; // 赤
                                // マイナスの場合はゲージの開始位置を右端に設定
                                mmrGaugeFill.style.left = 'auto';
                                mmrGaugeFill.style.right = '0';
                            } else {
                                // 0の場合はゲージなし（幅0）
                                mmrGaugeFill.style.width = '0%';
                                mmrGaugeFill.style.backgroundColor = '#F44336'; // 0は赤
                                mmrGaugeFill.style.left = '0';
                                mmrGaugeFill.style.right = 'auto';
                            }

                            // 元の背景色設定は不要になるか、ゲージの背景として利用
                            // lastMatchSection.style.backgroundColor = mmrChange > 0 ? '#4CAF50' : '#F44336';
                            lastMatchSection.style.display = 'flex'; // ゲージ表示のためflexに変更
                        } else {
                            lastMatchSection.style.display = 'none';
                        }

                    } else { // currentRank がない場合 (例: ランクなし)
                        document.getElementById('rankIcon').src = 'assets/images/ranks/ランクなし.png';
                        document.getElementById('rankText').textContent = 'ランクなし';
                        document.getElementById('rrText').textContent = '';
                        document.getElementById('winLossText').textContent = '';
                        document.getElementById('lastMatchSection').style.display = 'none';
                    }

                    // プロフィールAPIからのデータ（エージェントアイコン、KDA等）は使用しないため関連コードはコメントアウトのまま
                    // document.getElementById('playerName').textContent = `${name}#${tag}`;
                    // if (profile && profile.data && profile.data.agent) {
                    //     document.getElementById('agentIcon').src = getAgentImageUrl(profile.data.agent.name);
                    // }
                    // if (profile && profile.data && profile.data.stats) {
                    //     const stats = profile.data.stats;
                    //     document.getElementById('kda').textContent = `${stats.kills || 0}/${stats.deaths || 0}/${stats.assists || 0}`;
                    //     document.getElementById('hsPercent').textContent = `${Math.round((stats.headshots || 0) / (stats.bodyshots || 1) * 100)}%`;
                    //     document.getElementById('adr').textContent = Math.round((stats.damage || 0) / (stats.matches || 1));
                    // }

                } else { // stats または stats.data が存在しない場合
                    document.getElementById('rankIcon').src = 'assets/images/ranks/ランクなし.png';
                    document.getElementById('rankText').textContent = 'データなし';
                    document.getElementById('rrText').textContent = '';
                    document.getElementById('winLossText').textContent = '';
                    document.getElementById('lastMatchSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error updating player info:', error);
                // エラー発生時も表示をリセット
                document.getElementById('rankIcon').src = 'assets/images/ranks/ランクなし.png';
                document.getElementById('rankText').textContent = 'エラー';
                document.getElementById('rrText').textContent = '';
                document.getElementById('winLossText').textContent = '';
                document.getElementById('lastMatchSection').style.display = 'none';
            }
        }

        function generateURL() {
            const playerName = document.getElementById('playerName').value;
            const playerTag = document.getElementById('playerTag').value;
            
            if (!playerName || !playerTag) {
                alert('プレイヤー名とタグを入力してください。');
                return;
            }

            const currentURL = window.location.href.split('?')[0];
            const newURL = `${currentURL}?name=${encodeURIComponent(playerName)}&tag=${encodeURIComponent(playerTag)}&obs`;
            document.getElementById('generatedURL').value = newURL;
        }

        function copyURL() {
            const urlInput = document.getElementById('generatedURL');
            urlInput.select();
            document.execCommand('copy');
            alert('URLをコピーしました！');
        }

        // URLパラメータからプレイヤー情報を取得して表示
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const tag = urlParams.get('tag');
            const isOBS = urlParams.has('obs'); // obsパラメータを確認
            
            if (name && tag) {
                // URLパラメータがある場合は入力フォームを非表示
                document.getElementById('inputSection').style.display = 'none';

                if (isOBS) {
                    // OBSモードの場合のスタイル調整
                    document.body.style.backgroundColor = 'transparent'; // bodyの背景を透過
                    document.body.style.overflow = 'hidden'; // スクロールバーを非表示
                    // 背景アニメーション要素を非表示
                    const backgroundElement = document.querySelector('.background');
                    if (backgroundElement) {
                        backgroundElement.style.display = 'none';
                    }

                    // オーバーレイのOBS向け位置調整（中央に配置）
                    const overlayElement = document.querySelector('.overlay');
                    if (overlayElement) {
                        overlayElement.style.position = 'absolute'; // OBS内の要素として絶対配置
                        overlayElement.style.top = '50%';
                        overlayElement.style.left = '50%';
                        overlayElement.style.right = 'auto'; // 右固定を解除
                        overlayElement.style.transform = 'translate(-50%, -50%)'; // 中央寄せ
                    }

                    // 製作者紹介セクションを非表示
                    const authorSectionElement = document.querySelector('.author-section');
                    if (authorSectionElement) {
                        authorSectionElement.style.display = 'none';
                    }

                } else {
                    // 通常のブラウザ表示でのオーバーレイ位置調整
                    document.querySelector('.overlay').style.top = '50%';
                    document.querySelector('.overlay').style.transform = 'translateY(-50%)';
                    // PCレイアウトでの右寄せはCSSで制御されるためここではLeft/Rightの変更は不要
                }

                // プレイヤー情報を更新
                updatePlayerInfo(name, tag);
            } else if (isOBS) {
                 // name, tag パラメータがないが OBS モードの場合
                document.getElementById('inputSection').style.display = 'none';
                 const backgroundElement = document.querySelector('.background');
                 if (backgroundElement) {
                     backgroundElement.style.display = 'none';
                 }
                 // データがない旨を表示する、などの追加処理が必要であればここに記述
                 // 例: オーバーレイに「プレイヤー情報が設定されていません」と表示
                 document.getElementById('rankText').textContent = '情報なし';
                 document.getElementById('rrText').textContent = '';
                 document.getElementById('winLossText').textContent = '';
                 document.getElementById('lastMatchSection').style.display = 'none';
            } else {
                // name, tag パラメータがない通常のブラウザ表示の場合
                // 何もしない（入力フォームが表示されたままになる）
            }
        }
    </script>
</body>
</html> 